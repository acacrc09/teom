pipeline {
  agent {
    node {
      label 'nodejs'
    }
  }
  stages {
    stage ('Checkout codigo fuente') {
      steps {
        checkout scm
      }
    }
    stage ('Instalar dependencias') {
      steps {
        sh '''          
          npm install --verbose -d
        '''
      }
    }
    stage ('Pruebas unitarias') {
      steps {
        sh '''
          npm run unit
        '''
      }
    }
    stage ('Inspecci√≥n con Sonarqube: npm run sonar') {
      steps {
        sh '''          
        '''
      }
    }
    stage ('Publicar en Nexus: npm publish') {
      steps {
        sh '''          
        '''
      }
    }
    stage ('Desplegar') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject('teom') {
              openshift.selector('bc', 'nodejs-teom-develop').startBuild('--from-dir=./', '--wait=true', '--follow', '--loglevel=8')
            }
          }
        }
      }
    }
    stage ('Probar API con Newman') {
      steps {
        sh '''
          npm run newman
        '''
      }
    }
    stage ('Smoke Test JMeter') {
      steps {
        sh '''
          npm run performance
        '''
      }
    }
    stage ('Probar WEB con Nightwatch') {
      steps {
        sh '''
          npm run unit
        '''
      }
    }
  }
}
